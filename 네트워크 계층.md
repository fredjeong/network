# 3. 네트워크 계층

## 3.1 LAN을 넘어서는 네트워크 계층

### 데이터 링크 계층의 한계

- 물리 계층과 데이터 링크 계층만으로는 LAN을 넘어선 통신이 불가능함
    - 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움
    - 데이터 링크 계층에서 다루는 MAC 주소로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어려움
    - 네트워크에서는 정보를 주고받을 때 MAC 주소(물리 주소)와 IP 주소(논리 주소)를 함께 사용하며, 기본적으로 IP 주소를 우선으로 활용함

### 인터넷 프로토콜(IP; Internet Protocol)

#### IP 주소 형태

- IP 주소는 4바이트(32비트)로 주소를 표현할 수 있고, 숫자당 8비트로 표현되므로 0에서 255 사이에 있는 네 개의 10진수로 표기됨
    - 예시: 192.168.1.1

#### IP의 기능

- IP 주소 지정(IP addressing)
    - IP 주소를 바탕으로 송수신 대상을 지정하는 것

- IP 단편화(IP fragmentation)
    - 전송하고자 하는 패킷의 크기가 한 번에 전송 가능한 IP 패킷의 최대 크기인 MTU(Maximum Transmission Unit)보다 클 경우 이를 MTU 크기 이하의 복수의 패킷으로 나누는 것
    - MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합됨

#### IPv4

- IPv4 패킷의 필드
    - 식별자(identifier)
        - 패킷에 할당된 번호
        - 메시지 전송 과정에서 IPv4 패킷이 여러 조각으로 쪼개져서 전송되었을 때, 어떤 메시지로부터 쪼개졌는지를 인식하기 위해 사용
    - 플래그(flag)
        - 세 개의 비트로 구성된 필드
            - 첫 번째 비트는 항상 0으로 예약된 비트로서, 사용하지 않음
            - 두 번째 비트는 DF(Don't Fragment) 비트로, IP 단편화를 수행하지 말라는 표시
            - 세 번째 비트는 MF(More Fragment) 비트로, 단편화된 패킷이 더 있는지를 표시
                - 0이라면 이 패킷이 마지막 패킷임을 의미
                - 1이라면 쪼개진 패킷이 더 있다는 것을 의미
    - 단편화 오프셋(fragment offset)
        - 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타냄
    - TTL (Time to Live)
        - 패킷의 수명을 의미
        - 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소하고, TTL 값이 0으로 떨어진 패킷은 폐기됨
        - 홉(hop)
            - 패킷이 호스트 또는 라우터에 한 번 전달되는 것
        - 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위함
    - 프로토콜(protocol)
        - 상위 계층의 프로토콜이 무엇인지 나타내는 필드
    - 송신지 IP 주소(source IP address)와 수신지 IP 주소(destination IP address)
- 식별자, 플래그, 단편화 오프셋이 단편화와 재조합을 담당
- 프로토콜 필드로 상위 계층 프로토콜 확인
- TTL로 패킷의 남은 수명 파악
- 송신지 IP 주소, 수신지 IP 주소를 통해 IP 주소 지정

#### IPv6

- IPv4 주소는 4바이트(32바이트)로 표현되므로 이론적으로 할당 가능한 IPv4 주소는 $2^{32}$개로 약 43억 개에 달함
- IPv4 주소의 총량은 쉽게 고갈될 수 있어, 이를 보완하기 위해 IPv6가 등장
- 16바이트(128비트)로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기됨
- 이론적으로 $2^{128}$개의 주소를 할당 가능할 수 있어 사실상 무한에 가까운 개수
- IPv6 패킷의 필드
    - 다음 헤더(next header)
        - 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킴
        - IPv6는 추가적인 헤더 정보가 필요할 경우 기본 헤더와 더불어 확장 헤더(extension header)라는 추가적인 헤더를 가질 수 있음
    - 홉 제한(hop limit)
        - IPv4 패킷의 TTL 필드와 같이 패킷의 수명을 나타냄
    - 송신지 IP 주소와 수신지 IP 주소

### ARP (Address Resolution Protocol)

- 동일 네트워크에서 상대 호스트의 IP 주소는 알지만 MAC 주소를 알지 못할 때, IP 주소를 통해 MAC 주소를 알아내는 프로토콜
- 동작 과정
    - ARP 요청(ARP request)
    - ARP 응답(ARP reply)
    - ARP 테이블 갱신
- 다른 네트워크에 속한 호스트에게 패킷을 보내야 할 경우, 라우터의 MAC 주소를 알아내어 패킷을 전송

## 3.2 IP 주소

### 네트워크 주소와 호스트 주소

- 하나의 IP 주소는 네트워크 주소와 호스트 주소로 이루어짐
    - 네트워크 주소는 호스트가 속한 특정 네트워크를 식별하는 역할을 수행
    - 호스트 주소는 네트워크 내에서 특정 호스트를 식별하는 역할을 수행
- 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적일 수 있음
- 호스트 주소 공간을 지나치게 크게 할당하면 호스트가 할당되지 않은 다수의 IP 주소가 낭비될 수 있고, 지나치게 작게 할당하면 호스트가 사용할 IP 주소가 부족해질 수 있음

### 클래스풀 주소 체계 (Classful Addressing)

- 클래스
    - 네트워크 크기에 따라 IP 주소를 분류하는 기준
    - 클래스를 이용하면 필요한 호스트 IP 개수에 따라 네트워크 크기를 가변적으로 조정해 네트워크 주소와 호스트 주소를 구획할 수 있음
    - 클래스별 네트워크의 크기가 고정되어 있으므로 여전히 다수의 IP 주소가 낭비될 수 있음

### 클래스리스 주소 체계 (Classless Addressing)

#### 서브넷 마스크(subnet mask0)

- IP 주소 상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열
- 클래스리스 주소 체계는 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분

#### 서브네팅: 비트 AND 연산

- 네트워크 주소와 호스트 주소를 구분 짓기 위해서는 IP 주소와 서브넷 마스크를 비트 AND 연산하면 됨
- 이를 통해서 IP 주소 내의 네트워크 주소를 알아낼 수 있음

#### 서브넷 마스크 표기: CIDR 표기법 (Classless Inter-Domain Routing notation)

- 서브넷 마스크를 표기할 때, 'IP 주소/서브넷 마스크 상의 1의 개수' 형식으로 표기하는 방법

### 공인 IP 주소와 사설 IP 주소

#### 공인 IP 주소(public IP address)

- 전 세계에서 공유한 IP 주소
- 네트워크 간 통신을 위해 사용하는 IP 주소

#### 사설 IP 주소(private IP address)와 NAT(Network Address Translation)

- 사설 네트워크
    - 인터넷과 같은 외부 네트워크에 공개되지 않은 네트워크
    - LAN 내의 많은 호스트는 사설 IP 주소를 이용함
- NAT
    - 사설 IP 주소를 사용하는 호스트가 외부 네트워크와 통신하기 위해 사용하는 IP 변환 기술
    - 사설 IP 주소를 사용하는 여러 호스트는 적은 수의 공인 IP 주소를 공유할 수 있음

### 정적 IP 주소와 동적 IP 주소

#### 정적 할당

- 호스트에 직접 수작업으로 정적 IP 주소(static IP address)를 부여하는 방식

#### 동적 할당과 DHCP

- 호스트에 자동으로 동적 IP 주소(dynamic IP address)가 할당되는 방식
- DHCP(Dynamic Host Configuration Protocol)
    - 동적 할당을 위해 사용하는 프로토콜

## 3.3 라우팅

### 라우터

- 라우팅
    - 패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것
- 홉(hop)
    - 라우팅 도중 패킷이 호스트와 라우터 간에, 혹은 라우터와 라우터 간에 이동하는 과정
    - 패킷은 여러 홉을 거쳐 라우팅됨

### 라우팅 테이블

- 특정 수신지까지 도달하기 위한 정보를 표시한 테이블
- 라우터는 라우팅 테이블을 참고하여 수신지까지의 도달 경로를 판단함
- 명시 정보
    - 수신지 IP 주소와 서브넷 마스크
        - 최종적으로 패킷을 전달할 대상
    - 다음 홉(next hop) 또는 게이트웨이
        - 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP 주소나 인터페이스
    - 네트워크 인터페이스
        - 패킷을 내보낼 통로
        - 인터페이스(NIC) 이름이 직접적으로 명시되거나 인터페이스에 대응하는 IP 주소가 명시됨
    - 메트릭(metric)
        - 해당 경로로 이동하는 데 드는 비용
- 라우팅 테이블에 없는 경로로 패킷을 전송할 시 디폴트 라우트(default route)라는 기본 경로를 설정하여 해당 경로로 패킷을 내보냄

### 정적 라우팅과 동적 라우팅

#### 정적 라우팅(static routing)

- 사용자가 수동으로 직접 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식

#### 동적 라우팅(dynamic routing)

- 네트워크의 규모가 커지고 관리해야 할 라우터가 늘어나면 정적 라우팅으로는 관리가 어려움
- 자동으로 라우팅 테이블 항목을 만들고 이를 이용하여 라우팅하는 방식
- 동적 라우팅을 하면 라우팅 테이블의 항목이 수시로 변할 수 있음
- 네트워크 경로 상에 문제가 발생했을 때 이를 우회할 수 있게 경로가 자동으로 갱신되기도 함

### 라우팅 프로토콜

- 라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜
- AS(Autonomous System)
    - 동일한 라우팅 정책으로 운용되는 라우터들의 집단 네트워크
    - 한 회사나 단체에서 관리하는 라우터 집단

#### IGP: RIP와 OSPF

- IGP (Interior Gateway Protocol)
    - AS 내부에서 라우팅 프로토콜이 수행됨
- RIP (Routing Information Protocol)
    - 거리 벡터 기반의 라우팅 프로토콜
    - 거리는 패킷이 경유한 라우터의 수, 즉 홉의 수를 의미함
    - 특정 수신지까지 도달하기 위해 홉 수가 가장 적은 경로를 최적의 경로로 판단
- OSPF (Open Shortest Path First)
    - 링크 상태(link state) 기반의 라우팅 프로토콜
    - OSPF는 현재 네트워크의 상태를 그래프의 형태로 링크 상태 데이터베이스(LSDB; Link State DataBase)에 저장
    - 라우터들의 연결 관계, 연결 비용 등을 기반으로 최적의 경로 선택
    - 대역폭이 높은 링크일수록 메트릭(비용)이 낮은 경로로 인식

#### EGP: BGP

- EGP (Exterior Gateway Protocol)
    - AS 외부에서 라우팅 프로토콜이 수행됨
- BGP (Border Gateway Protocol)
    - AS 간의 통신이 가능한 프로토콜
    - BGP 라우터들끼리 연결되어 피어(peer)가 되면 BGP 라우터 간 BGP 메시질르 주고받을 수 있음
    - 경로 설정 과정에서 수신지 주소와 함께 다양한 속성과 정책이 고려되므로 RIP와 OSPF에 비해 최적 경로를 결정하는 과정이 복잡하고, 일정하지 않은 경우가 많음
        - 속성(attribute)
            - 경로에 대한 부가 정보